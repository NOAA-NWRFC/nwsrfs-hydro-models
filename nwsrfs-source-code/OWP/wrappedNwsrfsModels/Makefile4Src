# This is a template Makefile for all models under their source
# directory after the target all:
#
# File Name: Makefile4Src
# Author: Raymond.Chui@noaa.gov
# Created: August, 2009

include $(TOP_ROOF)MakefileTemplate

all : $(SUBDIRS) $(BUILD)

# Where the macro SUBDIRS is defined in each */Makefile file

# The below two targets are used for each */Makefile file
# Some use both targets, some only use one of them.

# Go to the CHPS directory to create the object files
chps :
	cd ${CHPSDIR}; \
	lssrc_f=`ls *.f 2> /dev/null`; \
	lssrc_c=`ls *.c 2> /dev/null`; \
	src_f=`echo $$lssrc_f`; \
	src_c=`echo $$lssrc_c`; \
	make -f $(TOP_ROOF)Makefile4Subdir SRC_F="$$src_f" SRC_C="$$src_c" TOBUILD=objs; \
	cd ..

# Where the macro CHPSDIR is defined in each */Makefile file

# Go thru each subdirectory to creat the object files (and create a library if need)
modules :
	for module in $(MODULES); do \
		cd $$module; \
		lssrc_c=`ls *.c 2> /dev/null`; src_c=`echo $$lssrc_c`; \
		lssrc_cc=`ls *.cxx 2> /dev/null`; src_cc=`echo $$lssrc_cc`; \
		lssrc_f=`ls *.f 2> /dev/null`; src_f=`echo $$lssrc_f`; \
		make -f $(TOP_ROOF)Makefile4Subdir SRC_C="$$src_c" SRC_CC="$$src_cc" SRC_F="$$src_f" TOBUILD=$(BUILD) ARCHIVE=$(LIB); \
		cd ..; \
	done

# Where the macro BUILD is defined in each */Makefile file
# where the macro MODULES is defined in each */Makefile file
# where the macro LIB is defined in MakefileTemplate file

# compile the executable binary with its library
#$(BIN) : ${OBJ} ${LIB}
libs : ${OBJ} ${LIB}
	mkdir -p $(BINDIR); rm -f $(OBJDIR)
	lsobj=`ls ../obj/*.o 2> /dev/null`; objs=`echo $$lsobj`; \
	$(LOADER) \
	$(MAPPER) \
	$(DIR_LOAD_FC) \
	$(DIR_LOAD_CXX) \
	$(OBJ) \
	$$objs \
	$(LIB) \
	$(OTHERLIB) \
	$(COMMONLIB) \
	$(NWSRFSLIB) \
	$(LIB_SYSTEM_FC) \
	$(LIB_SYSTEM_CXX) \
	-o $(BIN) 
#	-o $@

# compile the executable binary without its library
#$(BIN) :: ${OBJ}
objs : ${OBJ}
	mkdir -p $(BINDIR); rm -f $(OBJDIR)
	lsobj=`ls ../obj/*.o 2> /dev/null`; objs=`echo $$lsobj`; \
	$(LOADER) \
	$(MAPPER) \
	$(DIR_LOAD_FC) \
	$(DIR_LOAD_CXX) \
	$(OBJ) \
	$$objs \
	$(OTHERLIB) \
	$(COMMONLIB) \
	$(NWSRFSLIB) \
	$(LIB_SYSTEM_FC) \
	$(LIB_SYSTEM_CXX) \
	$(TOP_ROOF)../otherPrograms/common_libs/libs/libnetcdf.a \
	-o $(BIN) 
#	-o $@

# for the genStatesResj only
genStatesResj :
	mkdir -p ../obj
	$(COPY) $(TOP_ROOF)resj/src/resjchps/resj_writeStates.o ../obj

# for the genStatesRessngl only
genStatesRessngl :
	mkdir -p ../obj
	cd ../obj; \
	ar -xv $(TOP_ROOF)lagk/lib/liblagk.a fcmpk7.o \
	fintp7.o \
	fk7.o \
	fka7.o \
	flag7.o \
	fslag7.o \
	fop7.o \
	fprpc7.o \
	fqdt7.o \
	fserc7.o \
	ftwtl7.o \
	pina7.o \
	rdvcin.o \
	rdvcrl.o \
	ffrdin.o \
	ffrdrl.o; \
	$(COPY) $(TOP_ROOF)ressngl/src/utilities/ressngl_ReadWriteStates.o .; \
	cd ../src

clean :
	rm -f $(OBJ) $(BIN)

cleanall : clean
	rm -f */*.o
